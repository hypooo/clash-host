name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      version: ${{ steps.fetch.outputs.version }}
    steps:
    - name: Fetch current mihomo version
      id: fetch
      run: |
        CURRENT_VERSION=$(curl -sL https://github.com/vernesong/mihomo/releases/download/Prerelease-Alpha/version.txt)
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Restore cached version
      uses: actions/cache/restore@v4
      with:
        path: last_version.txt
        key: mihomo-version-placeholder
        restore-keys: |
          mihomo-version-

    - name: Compare versions
      id: compare
      run: |
        # 检查版本是否变化
        if [ -f "last_version.txt" ]; then
          LAST_VERSION=$(cat "last_version.txt")
          echo "Last version: $LAST_VERSION"
          if [ "${{ steps.fetch.outputs.version }}" = "$LAST_VERSION" ]; then
            echo "Version unchanged, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        else
          echo "No cached version found, will build"
        fi

        echo "should_build=true" >> $GITHUB_OUTPUT

    - name: Save version to cache
      if: steps.compare.outputs.should_build == 'true'
      uses: actions/cache/save@v4
      with:
        path: last_version.txt
        key: mihomo-version-${{ steps.fetch.outputs.version }}

    - name: Update version file
      if: steps.compare.outputs.should_build == 'true'
      run: |
        echo "${{ steps.fetch.outputs.version }}" > last_version.txt

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push multi-platform image
      uses: docker/build-push-action@v5
      with:
        context: ./build
        platforms: linux/amd64
        push: true
        provenance: false
        tags: |
          ghcr.io/hypooo/clash-host:latest
          ghcr.io/hypooo/clash-host:${{ needs.check-version.outputs.version }}
