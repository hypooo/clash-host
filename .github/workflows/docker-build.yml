name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      mihomo_version: ${{ steps.fetch.outputs.mihomo_version }}
      zashboard_version: ${{ steps.fetch.outputs.zashboard_version }}
    steps:
    - name: Fetch current versions
      id: fetch
      run: |
        # Fetch mihomo version
        MIHOMO_VERSION=$(curl -sL https://github.com/vernesong/mihomo/releases/download/Prerelease-Alpha/version.txt)
        echo "mihomo_version=$MIHOMO_VERSION" >> $GITHUB_OUTPUT

        # Fetch zashboard version
        ZASHBOARD_VERSION=$(curl -sL https://api.github.com/repos/Zephyruso/zashboard/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        echo "zashboard_version=$ZASHBOARD_VERSION" >> $GITHUB_OUTPUT

        echo "Current Mihomo: $MIHOMO_VERSION"
        echo "Current Zashboard: $ZASHBOARD_VERSION"

    - name: Restore cached versions
      uses: actions/cache/restore@v4
      with:
        path: |
          last_mihomo_version.txt
          last_zashboard_version.txt
        key: versions-cache-placeholder
        restore-keys: |
          versions-cache-

    - name: Compare versions
      id: compare
      run: |
        SHOULD_BUILD=false

        # Check Mihomo version
        if [ -f "last_mihomo_version.txt" ]; then
          LAST_MIHOMO=$(cat last_mihomo_version.txt)
          if [ "$LAST_MIHOMO" != "${{ steps.fetch.outputs.mihomo_version }}" ]; then
            echo "Mihomo version changed ($LAST_MIHOMO -> ${{ steps.fetch.outputs.mihomo_version }})"
            SHOULD_BUILD=true
          else
            echo "Mihomo version unchanged ($LAST_MIHOMO)"
          fi
        else
          echo "No cached Mihomo version found."
          SHOULD_BUILD=true
        fi

        # Check Zashboard version
        if [ -f "last_zashboard_version.txt" ]; then
          LAST_ZASHBOARD=$(cat last_zashboard_version.txt)
          if [ "$LAST_ZASHBOARD" != "${{ steps.fetch.outputs.zashboard_version }}" ]; then
            echo "Zashboard version changed ($LAST_ZASHBOARD -> ${{ steps.fetch.outputs.zashboard_version }})"
            SHOULD_BUILD=true
          else
            echo "Zashboard version unchanged ($LAST_ZASHBOARD)"
          fi
        else
          echo "No cached Zashboard version found."
          SHOULD_BUILD=true
        fi

        echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

    - name: Update version files
      if: steps.compare.outputs.should_build == 'true'
      run: |
        echo "${{ steps.fetch.outputs.mihomo_version }}" > last_mihomo_version.txt
        echo "${{ steps.fetch.outputs.zashboard_version }}" > last_zashboard_version.txt

    - name: Save versions to cache
      if: steps.compare.outputs.should_build == 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          last_mihomo_version.txt
          last_zashboard_version.txt
        key: versions-cache-${{ steps.fetch.outputs.mihomo_version }}-${{ steps.fetch.outputs.zashboard_version }}

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push multi-platform image
      uses: docker/build-push-action@v5
      with:
        context: ./build
        platforms: linux/amd64
        push: true
        provenance: false
        tags: |
          ghcr.io/hypooo/clash-host:latest
          ghcr.io/hypooo/clash-host:mihomo-${{ needs.check-version.outputs.mihomo_version }}_zashboard-${{ needs.check-version.outputs.zashboard_version }}
