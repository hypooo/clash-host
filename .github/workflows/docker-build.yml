name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if version unchanged'
        required: false
        default: false
        type: boolean

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
    - name: Get current mihomo version
      id: check
      run: |
        CURRENT_VERSION=$(curl -sL https://github.com/vernesong/mihomo/releases/download/Prerelease-Alpha/version.txt)
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

        # 对于 push 事件或强制构建，总是构建
        if [ "${{ github.event_name }}" = "push" ] || [ "${{ inputs.force_build }}" = "true" ]; then
          echo "should_build=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # 对于定时任务，检查版本是否变化
        CACHE_FILE="last_version.txt"
        if [ -f "$CACHE_FILE" ]; then
          LAST_VERSION=$(cat "$CACHE_FILE")
          if [ "$CURRENT_VERSION" = "$LAST_VERSION" ]; then
            echo "Version unchanged, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi

        echo "should_build=true" >> $GITHUB_OUTPUT

    - name: Cache version file
      uses: actions/cache@v4
      with:
        path: last_version.txt
        key: mihomo-version-${{ steps.check.outputs.version }}
        restore-keys: |
          mihomo-version-

    - name: Update cached version
      if: steps.check.outputs.should_build == 'true'
      run: |
        echo "${{ steps.check.outputs.version }}" > last_version.txt

  build-and-push:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push multi-platform image
      uses: docker/build-push-action@v5
      with:
        context: ./build
        platforms: linux/amd64
        push: true
        provenance: false
        tags: |
          ghcr.io/hypooo/clash-host:latest
          ghcr.io/hypooo/clash-host:${{ needs.check-version.outputs.version }}
